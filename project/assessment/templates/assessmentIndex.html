<!DOCTYPE html>
<html>
<head>
	<title>
		
	</title>
	<style type="text/css">
		table{
			width: 100%;
		}
		
		td[contenteditable='true'] {
			border:1px solid #bababa;
		}

		/*tbody:nth-child(odd){
			
			background-color: yellow;
		}

		tbody:nth-child(even){
			background-color: grey;
			background-repeat: no-repeat;
		}*/


	</style>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

</head>
<body>
	
	<div class="pull-right">
		<button data-toggle="modal" data-target="#modalUpload" class="btn btn-primary upload">Upload New File</button>
		<button class="btn btn-danger" onclick="window.location='/logout';" type="submit">Log Out</button>
	</div>
		 <div id="modalUpload" class="modal fade" tabindex = "-1" role="dialog">
		  	<div class="modal-dialog" role="document">
			 	<div class="modal-content" >
			      <div class="modal-header">
			        <h4 class="modal-title">Upload a CSV file</h4>
			        <h4>{{message}}</h4>
			      </div>
			      	<div class="modal-body">

						<form action = "http://localhost:5000/upload" method = "POST"
									enctype = "multipart/form-data" class="right">
								<div class="form-group">
								   <input id="fileUpload" type = "file" name = "file"/>
							    </div>
								
								<div class="form-group">
								   <button class="btn btn-default"> Submit </button>
							   	</div>
		     
						</form>
					      <div class="modal-footer">
					        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					      </div>
			    	</div>
		  		</div>
		  	</div>
		  </div>


	<div class="tableContainer">
				<table>
					<thead>
						<tr>
							<th>Ques Id</th>
							<th>Question</th>
							<th>Correct Answer</th>
							<th>Level</th>
							<th>Question Type</th>
							<th>Skill type</th>
							<th>Tags</th>
							<th>Action</th>
						</tr>
					</thead>
				
				<!-- <div class="tableContent">
				<table class="table table-striped"> -->
				
				{% for question in questions: %}
				<tbody >
					<tr class="question">
						<td >{{ question[0]}}</td>
						<td contenteditable="false" >{{ question[2]}}</td>
						<td contenteditable="false" >{{question[4]}}</td> 
						<td contenteditable="false" class='questionLevel'>
							<select backData="{{question[5]}}" class="level"></select>
						</td>
						<td contenteditable="false" class='quesType'>
							<select backData="{{question[6]}}" class="quesType"></select>
						</td> 
						<td contenteditable="false" class='skillType'>
							<select backData="{{question[7]}}" class="skillType"></select>
						</td>
						<td contenteditable="false" >{{ question[8] }}</td>
						<td>
							<button class="editButton" data-state="edit">edit</button>
						</td>               
					</tr>
							
					{% for option in question[3].split(','): %}
						<tr class='option'>
							<td></td>
							<td showData="{{option.strip('[] ')}}" >{{option.strip('[]" ')}}</td>
						</tr>	
					{% endfor %}			
				</tbody>
				{% endfor %}
				<!-- </table>	
				</div> -->
				
			</table>		
					
	</div>

	<script type="text/javascript">

		function getIndex(index){
			dict={0:"quesId",1:"question",2:"correctAnswer",3:"level",4:"questionType",5:"skillType",6:"tags"};
			return dict[index];
		}

		window.onload = function() {

			var selectElem = $("select.level");
			$.each(selectElem, function(index,sel) {

			  var levelArr = ['easy','medium','hard'];
			  levelArr.forEach(function(elem,index) {
			    $(sel).append("<option value="+(index+1)+">"+elem+"</option>");
			  });
			});

			var selectElem = $("select.quesType");
			$.each(selectElem, function(index,sel) {

			  var typeArr = ['single Choice','multiple choice','essay','short answer'];
			  typeArr.forEach(function(elem,index) {
			    $(sel).append("<option value="+(index+1)+">"+elem+"</option>");
			  });
			});

			var selectElem = $("select.skillType");
			$.each(selectElem, function(index,sel) {

			  var skillArr = ['logical','gk','reasoning','theory','numerical'];
			  skillArr.forEach(function(elem,index) {
			    $(sel).append("<option value="+(index+1)+">"+elem+"</option>");
			  });
			});

			var selLevel=$('select.level')
			$.each(selLevel,function(index,elem){
				$.each(elem,function(index,ele){
					if(ele.getAttribute('value')==elem.getAttribute('backData')){
						ele.setAttribute('selected',"selected");
					}
				
				});
			});

			var selType=$('select.quesType')
			$.each(selType,function(index,elem){
				$.each(elem,function(index,ele){
					if(ele.getAttribute('value')==elem.getAttribute('backData')){
						ele.setAttribute('selected',"selected");
					}
				
				});
			});

			var selSkill=$('select.skillType')
			$.each(selSkill,function(index,elem){
				$.each(elem,function(index,ele){
					if(ele.getAttribute('value')==elem.getAttribute('backData')){
						ele.setAttribute('selected',"selected");
					}
				
				});
			});
		}

		
		//$(document).ready(function(){ 
			$('.editButton').click(function(){
				
				if( $(this).attr('data-state') == 'save'){

					var ob={};
					var question =$(this).parent().siblings();
					
					$.each(question,function(index,currentTd){	
						if(index==3 || index==4 || index==5){
							ob[getIndex(index)] = $(currentTd).find('option:selected').attr('value');
							
						}
						else if(index!=7 ){
							//ob[getIndex(index)]=getData(index,currentTd.innerHTML);
							ob[getIndex(index)]=currentTd.innerHTML;
						}
					});
					
					var li="[";
					$(this).closest('.question').nextUntil('.question').each(function(index,elem) {
					  var ele = $(elem).find('td[showdata]')
					  
					  li=li+'"'+ele[0].innerHTML+'",'		
					});
					li=li.substring(0,li.length-1)+']'

					ob['options']=li;
					console.log(ob)
					$.ajax({
					    url: '/ajaxReceive',
					    type: 'POST',
					    data: JSON.stringify(ob),
					    contentType: 'application/json; charset=utf-8',
					    dataType: 'json',
					    async: false,
					    success: function(msg) {
					        console.log(msg['status']);;
					    }
					});
					
					var currentTD = $(this).parent().siblings();
					$.each(currentTD, function () {
					      $(this).prop('contenteditable', false)
					  });

					$(this).closest('.question').nextUntil('.question').each(function(index,elem) {
					  $(elem).find('td[showdata]').prop('contenteditable','false');
					});

					$(this).attr('data-state', $(this).attr('data-state') == 'edit' ? 'save' : 'edit');
			        $(this).text( $(this).attr('data-state') /*== 'edit' ? 'save' : 'edit'*/);
				//console.log(ob);
				}
				else {
	          	    var currentTD = $(this).parent().siblings();
	          	    
	          	    $.each(currentTD, function () {
					      $(this).prop('contenteditable', true)
					  });

					$(this).closest('.question').nextUntil('.question').each(function(index,elem) {
					  $(elem).find('td[showdata]').prop('contenteditable','true');
					});

			        $(this).attr('data-state', $(this).attr('data-state') == 'edit' ? 'save' : 'edit');
			        $(this).text( $(this).attr('data-state'));
				}
			});
		//});		
	</script>
	
</body>
</html>